import { Injectable } from '@angular/core';
import { forkJoin, from, of } from 'rxjs';
import { first, mergeMap, tap } from 'rxjs/operators';
import { DEFAULT_REDIRECT_KEY } from '../model/permissions-router-data.model';
import { isFunction, isPlainObject, transformStringToArray } from '../utils/utils';
import * as i0 from "@angular/core";
import * as i1 from "../service/permissions.service";
import * as i2 from "../service/roles.service";
import * as i3 from "@angular/router";
export class NgxPermissionsGuard {
    constructor(permissionsService, rolesService, router) {
        this.permissionsService = permissionsService;
        this.rolesService = rolesService;
        this.router = router;
    }
    canActivate(route, state) {
        return this.hasPermissions(route, state);
    }
    canActivateChild(childRoute, state) {
        return this.hasPermissions(childRoute, state);
    }
    canLoad(route) {
        return this.hasPermissions(route);
    }
    hasPermissions(route, state) {
        const routeDataPermissions = !!route && route.data ? route.data.permissions : {};
        const permissions = this.transformPermission(routeDataPermissions, route, state);
        if (this.isParameterAvailable(permissions.except)) {
            return this.passingExceptPermissionsValidation(permissions, route, state);
        }
        if (this.isParameterAvailable(permissions.only)) {
            return this.passingOnlyPermissionsValidation(permissions, route, state);
        }
        return true;
    }
    transformPermission(permissions, route, state) {
        const only = isFunction(permissions.only)
            ? permissions.only(route, state)
            : transformStringToArray(permissions.only);
        const except = isFunction(permissions.except)
            ? permissions.except(route, state)
            : transformStringToArray(permissions.except);
        const redirectTo = permissions.redirectTo;
        return {
            only,
            except,
            redirectTo
        };
    }
    isParameterAvailable(permission) {
        return !!permission && permission.length > 0;
    }
    passingExceptPermissionsValidation(permissions, route, state) {
        if (!!permissions.redirectTo
            && ((isFunction(permissions.redirectTo))
                || (isPlainObject(permissions.redirectTo) && !this.isRedirectionWithParameters(permissions.redirectTo)))) {
            let failedPermission = '';
            return from(permissions.except)
                .pipe(mergeMap(permissionsExcept => {
                return forkJoin([
                    this.permissionsService.hasPermission(permissionsExcept),
                    this.rolesService.hasOnlyRoles(permissionsExcept)
                ]).pipe(tap(hasPermissions => {
                    const dontHavePermissions = hasPermissions.every(hasPermission => hasPermission === false);
                    if (!dontHavePermissions) {
                        failedPermission = permissionsExcept;
                    }
                }));
            }), first(hasPermissions => hasPermissions.some(hasPermission => hasPermission === true), false), mergeMap(isAllFalse => {
                if (!!failedPermission) {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                    return of(false);
                }
                if (!isAllFalse && permissions.only) {
                    return this.onlyRedirectCheck(permissions, route, state);
                }
                return of(!isAllFalse);
            }))
                .toPromise();
        }
        return Promise.all([
            this.permissionsService.hasPermission(permissions.except),
            this.rolesService.hasOnlyRoles(permissions.except)
        ]).then(([hasPermission, hasRoles]) => {
            if (hasPermission || hasRoles) {
                if (permissions.redirectTo) {
                    this.redirectToAnotherRoute(permissions.redirectTo, route, state);
                }
                return false;
            }
            if (permissions.only) {
                return this.checkOnlyPermissions(permissions, route, state);
            }
            return true;
        });
    }
    redirectToAnotherRoute(permissionRedirectTo, route, state, failedPermissionName) {
        const redirectTo = isFunction(permissionRedirectTo)
            ? permissionRedirectTo(failedPermissionName, route, state)
            : permissionRedirectTo;
        if (this.isRedirectionWithParameters(redirectTo)) {
            redirectTo.navigationCommands = this.transformNavigationCommands(redirectTo.navigationCommands, route, state);
            redirectTo.navigationExtras = this.transformNavigationExtras(redirectTo.navigationExtras, route, state);
            this.router.navigate(redirectTo.navigationCommands, redirectTo.navigationExtras);
            return;
        }
        if (Array.isArray(redirectTo)) {
            this.router.navigate(redirectTo);
        }
        else {
            this.router.navigate([redirectTo]);
        }
    }
    isRedirectionWithParameters(object) {
        return (isPlainObject(object) && (!!object.navigationCommands || !!object.navigationExtras));
    }
    transformNavigationCommands(navigationCommands, route, state) {
        return isFunction(navigationCommands)
            ? navigationCommands(route, state)
            : navigationCommands;
    }
    transformNavigationExtras(navigationExtras, route, state) {
        return isFunction(navigationExtras)
            ? navigationExtras(route, state)
            : navigationExtras;
    }
    onlyRedirectCheck(permissions, route, state) {
        let failedPermission = '';
        return from(permissions.only)
            .pipe(mergeMap(permissionsOnly => {
            return forkJoin([
                this.permissionsService.hasPermission(permissionsOnly),
                this.rolesService.hasOnlyRoles(permissionsOnly)
            ]).pipe(tap(hasPermissions => {
                const failed = hasPermissions.every(hasPermission => hasPermission === false);
                if (failed) {
                    failedPermission = permissionsOnly;
                }
            }));
        }), first(hasPermissions => {
            if (isFunction(permissions.redirectTo)) {
                return hasPermissions.some(hasPermission => hasPermission === true);
            }
            return hasPermissions.every(hasPermission => hasPermission === false);
        }, false), mergeMap((pass) => {
            if (isFunction(permissions.redirectTo)) {
                if (pass) {
                    return of(true);
                }
                else {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                    return of(false);
                }
            }
            else {
                if (!!failedPermission) {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                }
                return of(!pass);
            }
        }))
            .toPromise();
    }
    handleRedirectOfFailedPermission(permissions, failedPermission, route, state) {
        if (this.isFailedPermissionPropertyOfRedirectTo(permissions, failedPermission)) {
            this.redirectToAnotherRoute(permissions.redirectTo[failedPermission], route, state, failedPermission);
        }
        else {
            if (isFunction(permissions.redirectTo)) {
                this.redirectToAnotherRoute(permissions.redirectTo, route, state, failedPermission);
            }
            else {
                this.redirectToAnotherRoute(permissions.redirectTo[DEFAULT_REDIRECT_KEY], route, state, failedPermission);
            }
        }
    }
    isFailedPermissionPropertyOfRedirectTo(permissions, failedPermission) {
        return (!!permissions.redirectTo && permissions.redirectTo[failedPermission]);
    }
    checkOnlyPermissions(purePermissions, route, state) {
        const permissions = {
            ...purePermissions
        };
        return Promise.all([
            this.permissionsService.hasPermission(permissions.only),
            this.rolesService.hasOnlyRoles(permissions.only)
        ]).then(([hasPermission, hasRole]) => {
            if (hasPermission || hasRole) {
                return true;
            }
            if (permissions.redirectTo) {
                this.redirectToAnotherRoute(permissions.redirectTo, route, state);
            }
            return false;
        });
    }
    passingOnlyPermissionsValidation(permissions, route, state) {
        if ((isFunction(permissions.redirectTo)
            || isPlainObject(permissions.redirectTo) && !this.isRedirectionWithParameters(permissions.redirectTo))) {
            return this.onlyRedirectCheck(permissions, route, state);
        }
        return this.checkOnlyPermissions(permissions, route, state);
    }
}
NgxPermissionsGuard.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: NgxPermissionsGuard, deps: [{ token: i1.NgxPermissionsService }, { token: i2.NgxRolesService }, { token: i3.Router }], target: i0.ɵɵFactoryTarget.Injectable });
NgxPermissionsGuard.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: NgxPermissionsGuard });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: NgxPermissionsGuard, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.NgxPermissionsService }, { type: i2.NgxRolesService }, { type: i3.Router }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMtZ3VhcmQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1wZXJtaXNzaW9ucy9zcmMvbGliL3JvdXRlci9wZXJtaXNzaW9ucy1ndWFyZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFZM0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFDSCxvQkFBb0IsRUFTdkIsTUFBTSx3Q0FBd0MsQ0FBQztBQUdoRCxPQUFPLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQVNuRixNQUFNLE9BQU8sbUJBQW1CO0lBRTVCLFlBQW9CLGtCQUF5QyxFQUFVLFlBQTZCLEVBQVUsTUFBYztRQUF4Ryx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQXVCO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWlCO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtJQUM1SCxDQUFDO0lBRUQsV0FBVyxDQUFDLEtBQTZCLEVBQUUsS0FBMEI7UUFDakUsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsVUFBa0MsRUFBRSxLQUEwQjtRQUMzRSxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRCxPQUFPLENBQUMsS0FBWTtRQUNoQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEMsQ0FB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LElBQUksYUFBYSxJQUFJLE9BQU8sRUFBRTtnQkFDMUIsT0FBTyxJQUFJLENBQUM7YUFDZjtZQUVELElBQUksV0FBVyxDQUFDLFVBQVUsRUFBRTtnQkFDeEIsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQ3JFO1lBRUQsT0FBTyxLQUFLLENBQUM7UUFDakIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8sZ0NBQWdDLENBQ3BDLFdBQStCLEVBQy9CLEtBQXFDLEVBQ3JDLEtBQTJCO1FBRTNCLElBQ0ksQ0FBQyxVQUFVLENBQWUsV0FBVyxDQUFDLFVBQVUsQ0FBQztlQUMxQyxhQUFhLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUM1RztZQUNFLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDNUQ7UUFDRCxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2hFLENBQUM7O2dIQS9SUSxtQkFBbUI7b0hBQW5CLG1CQUFtQjsyRkFBbkIsbUJBQW1CO2tCQUQvQixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LFxuICAgIENhbkFjdGl2YXRlLFxuICAgIENhbkFjdGl2YXRlQ2hpbGQsXG4gICAgQ2FuTG9hZCxcbiAgICBOYXZpZ2F0aW9uRXh0cmFzLFxuICAgIFJvdXRlLFxuICAgIFJvdXRlcixcbiAgICBSb3V0ZXJTdGF0ZVNuYXBzaG90XG59IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5cbmltcG9ydCB7IGZvcmtKb2luLCBmcm9tLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlyc3QsIG1lcmdlTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gICAgREVGQVVMVF9SRURJUkVDVF9LRVksXG4gICAgRXhjZXB0Rm4sXG4gICAgTmF2aWdhdGlvbkNvbW1hbmRzRm4sXG4gICAgTmF2aWdhdGlvbkV4dHJhc0ZuLFxuICAgIE5neFBlcm1pc3Npb25zUm91dGVyRGF0YSxcbiAgICBOZ3hSZWRpcmVjdFRvTmF2aWdhdGlvblBhcmFtZXRlcnMsXG4gICAgT25seUZuLFxuICAgIFJlZGlyZWN0VG8sXG4gICAgUmVkaXJlY3RUb0ZuXG59IGZyb20gJy4uL21vZGVsL3Blcm1pc3Npb25zLXJvdXRlci1kYXRhLm1vZGVsJztcbmltcG9ydCB7IE5neFBlcm1pc3Npb25zU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2UvcGVybWlzc2lvbnMuc2VydmljZSc7XG5pbXBvcnQgeyBOZ3hSb2xlc1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlL3JvbGVzLnNlcnZpY2UnO1xuaW1wb3J0IHsgaXNGdW5jdGlvbiwgaXNQbGFpbk9iamVjdCwgdHJhbnNmb3JtU3RyaW5nVG9BcnJheSB9IGZyb20gJy4uL3V0aWxzL3V0aWxzJztcblxuZXhwb3J0IGludGVyZmFjZSBOZ3hQZXJtaXNzaW9uc0RhdGEge1xuICAgIG9ubHk/OiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICBleGNlcHQ/OiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICByZWRpcmVjdFRvPzogUmVkaXJlY3RUbyB8IFJlZGlyZWN0VG9Gbjtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5neFBlcm1pc3Npb25zR3VhcmQgaW1wbGVtZW50cyBDYW5BY3RpdmF0ZSwgQ2FuTG9hZCwgQ2FuQWN0aXZhdGVDaGlsZCB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBlcm1pc3Npb25zU2VydmljZTogTmd4UGVybWlzc2lvbnNTZXJ2aWNlLCBwcml2YXRlIHJvbGVzU2VydmljZTogTmd4Um9sZXNTZXJ2aWNlLCBwcml2YXRlIHJvdXRlcjogUm91dGVyKSB7XG4gICAgfVxuXG4gICAgY2FuQWN0aXZhdGUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIHN0YXRlOiBSb3V0ZXJTdGF0ZVNuYXBzaG90KTogUHJvbWlzZTxib29sZWFuPiB8IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQZXJtaXNzaW9ucyhyb3V0ZSwgc3RhdGUpO1xuICAgIH1cblxuICAgIGNhbkFjdGl2YXRlQ2hpbGQoY2hpbGRSb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgc3RhdGU6IFJvdXRlclN0YXRlU25hcHNob3QpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHwgUHJvbWlzZTxib29sZWFuPiB8IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQZXJtaXNzaW9ucyhjaGlsZFJvdXRlLCBzdGF0ZSk7XG4gICAgfVxuXG4gICAgY2FuTG9hZChyb3V0ZTogUm91dGUpOiBib29sZWFuIHwgT2JzZXJ2YWJsZTxib29sZWFuPiB8IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQZXJtaXNzaW9ucyhyb3V0ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYXNQZXJtaXNzaW9ucyhyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLCBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3QpIHtcbiAgICAgICAgY29uc3Qgcm91dGVEYXRhUGVybWlzc2lvbnMgPSAhIXJvdXRlICYmIHJvdXRlLmRhdGEgPyAocm91dGUuZGF0YS5wZXJtaXNzaW9ucyBhcyBOZ3hQZXJtaXNzaW9uc1JvdXRlckRhdGEpIDoge307XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25zID0gdGhpcy50cmFuc2Zvcm1QZXJtaXNzaW9uKHJvdXRlRGF0YVBlcm1pc3Npb25zLCByb3V0ZSwgc3RhdGUpO1xuXG4gICAgICAgIGlmICh0aGlzLmlzUGFyYW1ldGVyQXZhaWxhYmxlKHBlcm1pc3Npb25zLmV4Y2VwdCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhc3NpbmdFeGNlcHRQZXJtaXNzaW9uc1ZhbGlkYXRpb24ocGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pc1BhcmFtZXRlckF2YWlsYWJsZShwZXJtaXNzaW9ucy5vbmx5KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFzc2luZ09ubHlQZXJtaXNzaW9uc1ZhbGlkYXRpb24ocGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zZm9ybVBlcm1pc3Npb24oXG4gICAgICAgIHBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc1JvdXRlckRhdGEsXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IE5neFBlcm1pc3Npb25zRGF0YSB7XG4gICAgICAgIGNvbnN0IG9ubHkgPSBpc0Z1bmN0aW9uPE9ubHlGbj4ocGVybWlzc2lvbnMub25seSlcbiAgICAgICAgICAgID8gcGVybWlzc2lvbnMub25seShyb3V0ZSwgc3RhdGUpXG4gICAgICAgICAgICA6IHRyYW5zZm9ybVN0cmluZ1RvQXJyYXkocGVybWlzc2lvbnMub25seSk7XG4gICAgICAgIGNvbnN0IGV4Y2VwdCA9IGlzRnVuY3Rpb248RXhjZXB0Rm4+KHBlcm1pc3Npb25zLmV4Y2VwdClcbiAgICAgICAgICAgID8gcGVybWlzc2lvbnMuZXhjZXB0KHJvdXRlLCBzdGF0ZSlcbiAgICAgICAgICAgIDogdHJhbnNmb3JtU3RyaW5nVG9BcnJheShwZXJtaXNzaW9ucy5leGNlcHQpO1xuICAgICAgICBjb25zdCByZWRpcmVjdFRvID0gcGVybWlzc2lvbnMucmVkaXJlY3RUbztcblxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBvbmx5LFxuICAgICAgICAgICAgZXhjZXB0LFxuICAgICAgICAgICAgcmVkaXJlY3RUb1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNQYXJhbWV0ZXJBdmFpbGFibGUocGVybWlzc2lvbjogc3RyaW5nIHwgc3RyaW5nW10pIHtcbiAgICAgICAgcmV0dXJuICEhcGVybWlzc2lvbiAmJiBwZXJtaXNzaW9uLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXNzaW5nRXhjZXB0UGVybWlzc2lvbnNWYWxpZGF0aW9uKFxuICAgICAgICBwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZTogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICAhIXBlcm1pc3Npb25zLnJlZGlyZWN0VG9cbiAgICAgICAgICAgICYmIChcbiAgICAgICAgICAgICAgICAoaXNGdW5jdGlvbjxSZWRpcmVjdFRvRm4+KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pKVxuICAgICAgICAgICAgICAgIHx8IChpc1BsYWluT2JqZWN0KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pICYmICF0aGlzLmlzUmVkaXJlY3Rpb25XaXRoUGFyYW1ldGVycyhwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSlcbiAgICAgICAgICAgIClcbiAgICAgICAgKSB7XG4gICAgICAgICAgICBsZXQgZmFpbGVkUGVybWlzc2lvbiA9ICcnO1xuXG4gICAgICAgICAgICByZXR1cm4gZnJvbShwZXJtaXNzaW9ucy5leGNlcHQpXG4gICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIG1lcmdlTWFwKHBlcm1pc3Npb25zRXhjZXB0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmb3JrSm9pbihbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1NlcnZpY2UuaGFzUGVybWlzc2lvbihwZXJtaXNzaW9uc0V4Y2VwdCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb2xlc1NlcnZpY2UuaGFzT25seVJvbGVzKHBlcm1pc3Npb25zRXhjZXB0KVxuICAgICAgICAgICAgICAgICAgICAgICAgXSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXAoaGFzUGVybWlzc2lvbnMgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkb250SGF2ZVBlcm1pc3Npb25zID0gaGFzUGVybWlzc2lvbnMuZXZlcnkoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSBmYWxzZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb250SGF2ZVBlcm1pc3Npb25zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWRQZXJtaXNzaW9uID0gcGVybWlzc2lvbnNFeGNlcHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgIGZpcnN0KGhhc1Blcm1pc3Npb25zID0+IGhhc1Blcm1pc3Npb25zLnNvbWUoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSB0cnVlKSwgZmFsc2UpLFxuICAgICAgICAgICAgICAgICAgICBtZXJnZU1hcChpc0FsbEZhbHNlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghIWZhaWxlZFBlcm1pc3Npb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVJlZGlyZWN0T2ZGYWlsZWRQZXJtaXNzaW9uKHBlcm1pc3Npb25zLCBmYWlsZWRQZXJtaXNzaW9uLCByb3V0ZSwgc3RhdGUpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0FsbEZhbHNlICYmIHBlcm1pc3Npb25zLm9ubHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vbmx5UmVkaXJlY3RDaGVjayhwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKCFpc0FsbEZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgLnRvUHJvbWlzZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmhhc1Blcm1pc3Npb24ocGVybWlzc2lvbnMuZXhjZXB0KSxcbiAgICAgICAgICAgIHRoaXMucm9sZXNTZXJ2aWNlLmhhc09ubHlSb2xlcyhwZXJtaXNzaW9ucy5leGNlcHQpXG4gICAgICAgIF0pLnRoZW4oKFtoYXNQZXJtaXNzaW9uLCBoYXNSb2xlc10pID0+IHtcbiAgICAgICAgICAgIGlmIChoYXNQZXJtaXNzaW9uIHx8IGhhc1JvbGVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFRvQW5vdGhlclJvdXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgcGVybWlzc2lvbnMucmVkaXJlY3RUbyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwZXJtaXNzaW9ucy5vbmx5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tPbmx5UGVybWlzc2lvbnMocGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWRpcmVjdFRvQW5vdGhlclJvdXRlKFxuICAgICAgICBwZXJtaXNzaW9uUmVkaXJlY3RUbzogUmVkaXJlY3RUbyB8IFJlZGlyZWN0VG9GbixcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90LFxuICAgICAgICBmYWlsZWRQZXJtaXNzaW9uTmFtZT86IHN0cmluZ1xuICAgICk6IHZvaWQge1xuXG4gICAgICAgIGNvbnN0IHJlZGlyZWN0VG8gPSBpc0Z1bmN0aW9uPFJlZGlyZWN0VG9Gbj4ocGVybWlzc2lvblJlZGlyZWN0VG8pXG4gICAgICAgICAgICA/IHBlcm1pc3Npb25SZWRpcmVjdFRvKGZhaWxlZFBlcm1pc3Npb25OYW1lLCByb3V0ZSwgc3RhdGUpXG4gICAgICAgICAgICA6IHBlcm1pc3Npb25SZWRpcmVjdFRvO1xuXG4gICAgICAgIGlmICh0aGlzLmlzUmVkaXJlY3Rpb25XaXRoUGFyYW1ldGVycyhyZWRpcmVjdFRvKSkge1xuICAgICAgICAgICAgcmVkaXJlY3RUby5uYXZpZ2F0aW9uQ29tbWFuZHMgPSB0aGlzLnRyYW5zZm9ybU5hdmlnYXRpb25Db21tYW5kcyhyZWRpcmVjdFRvLm5hdmlnYXRpb25Db21tYW5kcywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgICAgIHJlZGlyZWN0VG8ubmF2aWdhdGlvbkV4dHJhcyA9IHRoaXMudHJhbnNmb3JtTmF2aWdhdGlvbkV4dHJhcyhyZWRpcmVjdFRvLm5hdmlnYXRpb25FeHRyYXMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShyZWRpcmVjdFRvLm5hdmlnYXRpb25Db21tYW5kcywgcmVkaXJlY3RUby5uYXZpZ2F0aW9uRXh0cmFzKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlZGlyZWN0VG8pKSB7XG4gICAgICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShyZWRpcmVjdFRvKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFtyZWRpcmVjdFRvXSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGlzUmVkaXJlY3Rpb25XaXRoUGFyYW1ldGVycyhvYmplY3Q6IGFueSB8IE5neFJlZGlyZWN0VG9OYXZpZ2F0aW9uUGFyYW1ldGVycyk6IG9iamVjdCBpcyBOZ3hSZWRpcmVjdFRvTmF2aWdhdGlvblBhcmFtZXRlcnMge1xuICAgICAgICByZXR1cm4gKGlzUGxhaW5PYmplY3Qob2JqZWN0KSAmJiAoISFvYmplY3QubmF2aWdhdGlvbkNvbW1hbmRzIHx8ICEhb2JqZWN0Lm5hdmlnYXRpb25FeHRyYXMpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zZm9ybU5hdmlnYXRpb25Db21tYW5kcyhcbiAgICAgICAgbmF2aWdhdGlvbkNvbW1hbmRzOiBhbnlbXSB8IE5hdmlnYXRpb25Db21tYW5kc0ZuLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApOiBhbnlbXSB7XG4gICAgICAgIHJldHVybiBpc0Z1bmN0aW9uPE5hdmlnYXRpb25Db21tYW5kc0ZuPihuYXZpZ2F0aW9uQ29tbWFuZHMpXG4gICAgICAgICAgICA/IG5hdmlnYXRpb25Db21tYW5kcyhyb3V0ZSwgc3RhdGUpXG4gICAgICAgICAgICA6IG5hdmlnYXRpb25Db21tYW5kcztcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zZm9ybU5hdmlnYXRpb25FeHRyYXMoXG4gICAgICAgIG5hdmlnYXRpb25FeHRyYXM6IE5hdmlnYXRpb25FeHRyYXMgfCBOYXZpZ2F0aW9uRXh0cmFzRm4sXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IE5hdmlnYXRpb25FeHRyYXMge1xuICAgICAgICByZXR1cm4gaXNGdW5jdGlvbjxOYXZpZ2F0aW9uRXh0cmFzRm4+KG5hdmlnYXRpb25FeHRyYXMpXG4gICAgICAgICAgICA/IG5hdmlnYXRpb25FeHRyYXMocm91dGUsIHN0YXRlKVxuICAgICAgICAgICAgOiBuYXZpZ2F0aW9uRXh0cmFzO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25seVJlZGlyZWN0Q2hlY2soXG4gICAgICAgIHBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc0RhdGEsXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBsZXQgZmFpbGVkUGVybWlzc2lvbiA9ICcnO1xuXG4gICAgICAgIHJldHVybiBmcm9tKHBlcm1pc3Npb25zLm9ubHkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtZXJnZU1hcChwZXJtaXNzaW9uc09ubHkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm9ya0pvaW4oW1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1NlcnZpY2UuaGFzUGVybWlzc2lvbihwZXJtaXNzaW9uc09ubHkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb2xlc1NlcnZpY2UuaGFzT25seVJvbGVzKHBlcm1pc3Npb25zT25seSlcbiAgICAgICAgICAgICAgICAgICAgXSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcChoYXNQZXJtaXNzaW9ucyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmFpbGVkID0gaGFzUGVybWlzc2lvbnMuZXZlcnkoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSBmYWxzZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmFpbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZFBlcm1pc3Npb24gPSBwZXJtaXNzaW9uc09ubHk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBmaXJzdChoYXNQZXJtaXNzaW9ucyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbjxSZWRpcmVjdFRvRm4+KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhhc1Blcm1pc3Npb25zLnNvbWUoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhhc1Blcm1pc3Npb25zLmV2ZXJ5KGhhc1Blcm1pc3Npb24gPT4gaGFzUGVybWlzc2lvbiA9PT0gZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBmYWxzZSksXG4gICAgICAgICAgICAgICAgbWVyZ2VNYXAoXG4gICAgICAgICAgICAgICAgICAgIChwYXNzOiBib29sZWFuKTogT2JzZXJ2YWJsZTxib29sZWFuPiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbjxSZWRpcmVjdFRvRm4+KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlUmVkaXJlY3RPZkZhaWxlZFBlcm1pc3Npb24ocGVybWlzc2lvbnMsIGZhaWxlZFBlcm1pc3Npb24sIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoISFmYWlsZWRQZXJtaXNzaW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlUmVkaXJlY3RPZkZhaWxlZFBlcm1pc3Npb24ocGVybWlzc2lvbnMsIGZhaWxlZFBlcm1pc3Npb24sIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZighcGFzcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAudG9Qcm9taXNlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVSZWRpcmVjdE9mRmFpbGVkUGVybWlzc2lvbihcbiAgICAgICAgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSxcbiAgICAgICAgZmFpbGVkUGVybWlzc2lvbjogc3RyaW5nLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApIHtcbiAgICAgICAgaWYgKHRoaXMuaXNGYWlsZWRQZXJtaXNzaW9uUHJvcGVydHlPZlJlZGlyZWN0VG8ocGVybWlzc2lvbnMsIGZhaWxlZFBlcm1pc3Npb24pKSB7XG4gICAgICAgICAgICB0aGlzLnJlZGlyZWN0VG9Bbm90aGVyUm91dGUocGVybWlzc2lvbnMucmVkaXJlY3RUb1tmYWlsZWRQZXJtaXNzaW9uXSwgcm91dGUsIHN0YXRlLCBmYWlsZWRQZXJtaXNzaW9uKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uPFJlZGlyZWN0VG9Gbj4ocGVybWlzc2lvbnMucmVkaXJlY3RUbykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZGlyZWN0VG9Bbm90aGVyUm91dGUocGVybWlzc2lvbnMucmVkaXJlY3RUbywgcm91dGUsIHN0YXRlLCBmYWlsZWRQZXJtaXNzaW9uKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFRvQW5vdGhlclJvdXRlKHBlcm1pc3Npb25zLnJlZGlyZWN0VG9bREVGQVVMVF9SRURJUkVDVF9LRVldLCByb3V0ZSwgc3RhdGUsIGZhaWxlZFBlcm1pc3Npb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0ZhaWxlZFBlcm1pc3Npb25Qcm9wZXJ0eU9mUmVkaXJlY3RUbyhwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhLCBmYWlsZWRQZXJtaXNzaW9uOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICghIXBlcm1pc3Npb25zLnJlZGlyZWN0VG8gJiYgcGVybWlzc2lvbnMucmVkaXJlY3RUb1tmYWlsZWRQZXJtaXNzaW9uXSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjaGVja09ubHlQZXJtaXNzaW9ucyhcbiAgICAgICAgcHVyZVBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc0RhdGEsXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCBwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhID0ge1xuICAgICAgICAgICAgLi4ucHVyZVBlcm1pc3Npb25zXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmhhc1Blcm1pc3Npb24ocGVybWlzc2lvbnMub25seSksXG4gICAgICAgICAgICB0aGlzLnJvbGVzU2VydmljZS5oYXNPbmx5Um9sZXMocGVybWlzc2lvbnMub25seSlcbiAgICAgICAgXSkudGhlbigoW2hhc1Blcm1pc3Npb24sIGhhc1JvbGVdKSA9PiB7XG4gICAgICAgICAgICBpZiAoaGFzUGVybWlzc2lvbiB8fCBoYXNSb2xlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFRvQW5vdGhlclJvdXRlKHBlcm1pc3Npb25zLnJlZGlyZWN0VG8sIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXNzaW5nT25seVBlcm1pc3Npb25zVmFsaWRhdGlvbihcbiAgICAgICAgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSxcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIChpc0Z1bmN0aW9uPFJlZGlyZWN0VG9Gbj4ocGVybWlzc2lvbnMucmVkaXJlY3RUbylcbiAgICAgICAgICAgICAgICB8fCBpc1BsYWluT2JqZWN0KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pICYmICF0aGlzLmlzUmVkaXJlY3Rpb25XaXRoUGFyYW1ldGVycyhwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vbmx5UmVkaXJlY3RDaGVjayhwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5jaGVja09ubHlQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICB9XG59XG4iXX0=